vcr
===

```{r echo=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE
)
```

[![Build Status](https://travis-ci.org/ropensci/vcr.svg?branch=webmockit)](https://travis-ci.org/ropensci/vcr)

An R port of the Ruby gem [vcr](https://github.com/vcr/vcr)

## Overview/Terminology

* Cassette: A _thing_ to record HTTP interactions to. Right now the only option is file system, but in the future could be other things, e.g. a key-value store
* Persisters: defines how to save requests - currently only option is the file system
* Serializers: defines how to serialize the HTTP response - currently only option is YAML
* _insert cassette_: aka, create a cassette
* _eject cassette_: aka, check for saved interactions, and replay if found
* _replay_: refers to using a cached result of a http request that was recorded earlier
* How `vcr` matches: By default it matches on the HTTP method and the URI, but you can tweak this using the `match_requests_on` option.

<details> <summary><strong>How it works in way too much detail</strong></summary> <p>

The very very short version is: `vcr` helps you stub HTTP requests so you 
don't have to repeat yourself.

**The Steps**

1. Make a request inside of a call to either `vcr::use_cassette` or xxx
2. `webmockr` constructs a HTTP request, without executing that request
3. `webmockr` looks for a match of that request to cached requests 
wherever you chose to cache requests
4. One of two things then happens:
4a. If the request is not matched, we execute that request
4b. If the request is matched, we serve back the cached response
in the same exact format as you'd get back by using the HTTP client
without `vcr`

****

## Installation

```{r eval=FALSE}
devtools::install_github("ropensci/vcr")
```

```{r}
library("vcr")
library("crul")
```

## Best practices

* `vcr` for a package test suite 
  * put cassettes in a separate folder, and make sure to `.Rbuildignore` it - depending on its size you may want to add it to `.gitignore` as well. 
  * make sure to add `vcr` to `Suggests` in your package
  * If you want to clean up all cassettes at the end of the R session, run
  `xxx`
* `vcr` as a dependency in a package (i.e., Depends, Imports)
  * probably best to allow the user of your package to determine where cassettes are cached, so exposing `vcr` configuration tools to users
* `vcr` in your R analysis/project
  * still to come ...

## Configuration

Without the user doing anything, we set a number of defaults for easy usage:

* `dir` = "~/vcr/vcr_cassettes"
* `record` = "once"
* `match_requests_on` = `c("method", "uri")`
* `allow_unused_http_interactions` = `TRUE`
* `serialize_with` = "yaml"
* `persist_with` = "FileSystem"
* `ignore_hosts` = `NULL`
* `ignore_localhost` = `FALSE`
* `ignore_request` = `NULL`
* `uri_parser` = `httr::parse_url`
* `preserve_exact_body_bytes` = `FALSE`
* `preserve_exact_body_bytes_for` = `FALSE`
* `turned_off` = `FALSE`
* `ignore_cassettes` = `FALSE`
* `cassettes` = `list()` # empty set
* `linked_context` = `NULL`
* `vcr_logging` = "vcr.log"

You can get the defaults programatically with 

```{r eval=FALSE}
vcr_config_defaults()
```

However, you can change all the above defaults via calling 
`vcr_configure()`

```{r}
vcr_configure(
  dir = "fixtures/vcr_cassettes",
  record = "all"
)
```

Calling `vcr_configuration()` gives you some of the more important defaults in a nice tidy print out

```{r}
vcr_configuration()
```

```{r echo=FALSE} 
# set back to original
vcr_configure()
```

## Basic usage

```{r echo=FALSE}
unlink(file.path(cassette_path(), "helloworld.yml"))
```

```{r}
cli <- crul::HttpClient$new(url = "https://httpbin.org/get")
system.time(
  use_cassette("helloworld", {
    cli$get()
  })
)
```

The request gets recorded, and all subsequent requests of the same form used the cached HTTP response, and so are much faster

```{r}
system.time(
  use_cassette("helloworld", {
    GET("https://httpbin.org/get")
  })
)
```

`use_cassette()` is an easier approach. An alternative is to use 
`insert_cassett()` + `eject_cassette()`. 

`use_cassette()` does both insert and eject operations for you, but 
you can instead do them manually by using the above functions. You do have
to eject the cassette after using insert.

## Matchers

`vcr` looks for similarity in your HTTP requests to cached requests. You 
can set what is examined about the request with one or more of the 
following options:

* `body`
* `headers`
* `host`
* `method`
* `path`
* `query`
* `uri`

By default, we use `method` (HTTP method, e.g., `GET`) and `uri` (test for exact match against URI). 

You can set your own options like:

```{r echo=FALSE}
unlink(file.path(cassette_path(), "one.yml"))
```

```{r}
use_cassette(name = "one", {
    POST("https://httpbin.org/post", add_headers(a = 5))
  }, 
  match_requests_on = c('method', 'headers', 'query')
)
```

## vcr in other languages

The canonical `vcr` (in Ruby) lists ports in other languages at <https://github.com/vcr/vcr>

## Meta

* Please [report any issues or bugs](https://github.com/ropensci/vcr/issues)
* License: MIT
* Get citation information for `vcr` in R doing `citation(package = 'vcr')`
* Please note that this project is released with a [Contributor Code of Conduct](CODE_OF_CONDUCT.md). By participating in this project you agree to abide by its terms.

[![ropensci_footer](https://ropensci.org/public_images/github_footer.png)](https://ropensci.org)
